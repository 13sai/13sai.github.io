<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Nginx工作模式和进程模型 | 13sai blog</title><meta name="description" content="Nginx代理缓存"><meta name="keywords" content="nginx"><meta name="author" content="13sai"><meta name="copyright" content="13sai"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Nginx工作模式和进程模型"><meta name="twitter:description" content="Nginx代理缓存"><meta name="twitter:image" content="http://github.13sai.com/upload/article/nginx2.jpeg"><meta property="og:type" content="article"><meta property="og:title" content="Nginx工作模式和进程模型"><meta property="og:url" content="http://github.13sai.com/2019/12/20/216/"><meta property="og:site_name" content="13sai blog"><meta property="og:description" content="Nginx代理缓存"><meta property="og:image" content="http://github.13sai.com/upload/article/nginx2.jpeg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://github.13sai.com/2019/12/20/216/"><link rel="prev" title="五大网络IO模型" href="http://github.13sai.com/2019/12/26/218/"><link rel="next" title="gRPC初体验" href="http://github.13sai.com/2019/12/20/215/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight_copy: 'false',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false,
  ClickShowText: undefined,
  medium_zoom: 'false',
  Snackbar: undefined
  
}</script></head><body><div id="header"> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">13sai blog</a></span><i class="fa fa-bars fa-fw toggle-menu pull_right close" aria-hidden="true"></i><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder-open" aria-hidden="true"></i><span> 分类</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/nginx/"><i class="fa-fw"></i><span> Nginx</span></a></li><li><a class="site-page" href="/categories/mysql/"><i class="fa-fw"></i><span> Mysql</span></a></li><li><a class="site-page" href="/categories/php/"><i class="fa-fw"></i><span> PHP</span></a></li><li><a class="site-page" href="/categories/redis/"><i class="fa-fw"></i><span> Redis</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 书签</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lazyload avatar_img" src="http://image.13sai.com/sai.jpg" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">190</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">40</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">27</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder-open" aria-hidden="true"></i><span> 分类</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/nginx/"><i class="fa-fw"></i><span> Nginx</span></a></li><li><a class="site-page" href="/categories/mysql/"><i class="fa-fw"></i><span> Mysql</span></a></li><li><a class="site-page" href="/categories/php/"><i class="fa-fw"></i><span> PHP</span></a></li><li><a class="site-page" href="/categories/redis/"><i class="fa-fw"></i><span> Redis</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 书签</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#工作模式"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">工作模式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#进程模型"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">进程模型</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#master进程"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">master进程</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#重启说明（示例）"><span class="toc_mobile_items-number">2.1.1.</span> <span class="toc_mobile_items-text">重启说明（示例）</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#worker进程"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">worker进程</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#worker进程是如何处理请求的？"><span class="toc_mobile_items-number">2.2.1.</span> <span class="toc_mobile_items-text">worker进程是如何处理请求的？</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Nginx采用的IO多路复用模型"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">Nginx采用的IO多路复用模型</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#select"><span class="toc_mobile_items-number">2.3.0.1.</span> <span class="toc_mobile_items-text">select</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-6"><a class="toc_mobile_items-link" href="#基本原理"><span class="toc_mobile_items-number">2.3.0.1.1.</span> <span class="toc_mobile_items-text">基本原理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-6"><a class="toc_mobile_items-link" href="#优点"><span class="toc_mobile_items-number">2.3.0.1.2.</span> <span class="toc_mobile_items-text">优点</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-6"><a class="toc_mobile_items-link" href="#缺点"><span class="toc_mobile_items-number">2.3.0.1.3.</span> <span class="toc_mobile_items-text">缺点</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#poll"><span class="toc_mobile_items-number">2.3.0.2.</span> <span class="toc_mobile_items-text">poll</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-6"><a class="toc_mobile_items-link" href="#基本原理-1"><span class="toc_mobile_items-number">2.3.0.2.1.</span> <span class="toc_mobile_items-text">基本原理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-6"><a class="toc_mobile_items-link" href="#优点-1"><span class="toc_mobile_items-number">2.3.0.2.2.</span> <span class="toc_mobile_items-text">优点</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-6"><a class="toc_mobile_items-link" href="#缺点-1"><span class="toc_mobile_items-number">2.3.0.2.3.</span> <span class="toc_mobile_items-text">缺点</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#epoll"><span class="toc_mobile_items-number">2.3.0.3.</span> <span class="toc_mobile_items-text">epoll</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-6"><a class="toc_mobile_items-link" href="#基本原理-2"><span class="toc_mobile_items-number">2.3.0.3.1.</span> <span class="toc_mobile_items-text">基本原理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-6"><a class="toc_mobile_items-link" href="#epoll对文件描述符的操作有两种模式"><span class="toc_mobile_items-number">2.3.0.3.2.</span> <span class="toc_mobile_items-text">epoll对文件描述符的操作有两种模式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-6"><a class="toc_mobile_items-link" href="#优点-2"><span class="toc_mobile_items-number">2.3.0.3.3.</span> <span class="toc_mobile_items-text">优点</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-5"><a class="toc_mobile_items-link" href="#kqueue"><span class="toc_mobile_items-number">2.3.0.4.</span> <span class="toc_mobile_items-text">kqueue</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#工作模式"><span class="toc-number">1.</span> <span class="toc-text">工作模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#进程模型"><span class="toc-number">2.</span> <span class="toc-text">进程模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#master进程"><span class="toc-number">2.1.</span> <span class="toc-text">master进程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#重启说明（示例）"><span class="toc-number">2.1.1.</span> <span class="toc-text">重启说明（示例）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#worker进程"><span class="toc-number">2.2.</span> <span class="toc-text">worker进程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#worker进程是如何处理请求的？"><span class="toc-number">2.2.1.</span> <span class="toc-text">worker进程是如何处理请求的？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx采用的IO多路复用模型"><span class="toc-number">2.3.</span> <span class="toc-text">Nginx采用的IO多路复用模型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#select"><span class="toc-number">2.3.0.1.</span> <span class="toc-text">select</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#基本原理"><span class="toc-number">2.3.0.1.1.</span> <span class="toc-text">基本原理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#优点"><span class="toc-number">2.3.0.1.2.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#缺点"><span class="toc-number">2.3.0.1.3.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#poll"><span class="toc-number">2.3.0.2.</span> <span class="toc-text">poll</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#基本原理-1"><span class="toc-number">2.3.0.2.1.</span> <span class="toc-text">基本原理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#优点-1"><span class="toc-number">2.3.0.2.2.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#缺点-1"><span class="toc-number">2.3.0.2.3.</span> <span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#epoll"><span class="toc-number">2.3.0.3.</span> <span class="toc-text">epoll</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#基本原理-2"><span class="toc-number">2.3.0.3.1.</span> <span class="toc-text">基本原理</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#epoll对文件描述符的操作有两种模式"><span class="toc-number">2.3.0.3.2.</span> <span class="toc-text">epoll对文件描述符的操作有两种模式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#优点-2"><span class="toc-number">2.3.0.3.3.</span> <span class="toc-text">优点</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#kqueue"><span class="toc-number">2.3.0.4.</span> <span class="toc-text">kqueue</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/upload/article/nginx2.jpeg)"><div id="post-info"><div id="post-title"><div class="posttitle">Nginx工作模式和进程模型</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-12-20<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-12-20</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/nginx/">nginx</a></span><div class="post-meta-wordcount"><i class="fa fa-eye post-meta__icon" aria-hidden="true">       </i><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h2 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h2><ol>
<li>Nginx启动后，会产生一个master主进程，主进程执行一系列的工作后会产生一个或者多个工作进程worker</li>
<li>在客户端请求动态站点的过程中，Nginx服务器还涉及和后端服务器的通信。Nginx将接收到的Web请求通过代理转发到后端服务器，由后端服务器进行数据处理和组织;</li>
<li>Nginx为了提高对请求的响应效率，降低网络压力，采用了缓存机制，将历史应答数据缓存到本地。保障对缓存文件的快速访问</li>
</ol>
<h2 id="进程模型"><a href="#进程模型" class="headerlink" title="进程模型"></a>进程模型</h2><p>nginx的进程模型，可以由下图来表示：</p>
<p><img alt="image" data-src="https://cdn.learnku.com/uploads/images/201912/20/41489/gVfCciWSaq.png!large" class="lazyload"></p>
<h3 id="master进程"><a href="#master进程" class="headerlink" title="master进程"></a>master进程</h3><p>主要用来管理 worker 进程，master进程会接收来自外界发来的信号，再根据信号做不同的事情。所以我们要控制nginx，只需要通过kill向master进程发送信号就行了。</p>
<p>具体包括以下主要功能:</p>
<ul>
<li>接收来自外界的信号</li>
<li>向各worker进程发送信号</li>
<li>监控worker进程的运行状态，当worker进程退出后(异常情况下)，会自动重新启动新的worker进程</li>
</ul>
<h4 id="重启说明（示例）"><a href="#重启说明（示例）" class="headerlink" title="重启说明（示例）"></a>重启说明（示例）</h4><p>比如kill -HUP pid，则是告诉nginx，重启nginx，早期版本可以用这个信号来重启nginx，因为是从容地重启，因此服务是不中断的。（现在一般使用<code>nginx -s reload</code>）</p>
<p>master进程在接收到HUP信号后，会先重新加载配置文件，然后再启动新的worker进程，并向所有老的worker进程发送信号，告诉他们可以光荣退休了。新的worker在启动后，就开始接收新的请求，而老的worker在收到来自master的信号后，就不再接收新的请求，并且在当前进程中的所有未处理完的请求处理完成后，再退出。</p>
<blockquote>
<p>（master不需要处理网络事件，不负责业务的执行）</p>
</blockquote>
<h3 id="worker进程"><a href="#worker进程" class="headerlink" title="worker进程"></a>worker进程</h3><p>主要任务是完成具体的任务逻辑。其主要关注点是与客户端或后端真实服务器(此时 worker 作为中间代理)之间的数据可读/可写等I/O交互事件。具体包括以下主要功能:</p>
<ul>
<li>接收客户端请求;</li>
<li>将请求一次送入各个功能模块进行过滤处理;</li>
<li>与后端服务器通信，接收后端服务器处理结果;</li>
<li>数据缓存proxy_cache模块</li>
<li>响应客户端请求</li>
</ul>
<p>（一个请求，完全由worker进程来处理，而且只在一个worker进程中处理。）</p>
<h4 id="worker进程是如何处理请求的？"><a href="#worker进程是如何处理请求的？" class="headerlink" title="worker进程是如何处理请求的？"></a>worker进程是如何处理请求的？</h4><p>首先，worker进程之间是平等的，每个worker进程都是从master进程fork过来，在master进程里面，先建立好需要listen的socket（listenfd）之后，然后再fork出多个worker进程。每个worker进程，处理请求的机会也是一样的。当一个连接请求过来，每个进程都有可能处理这个连接，怎么做的呢？</p>
<p>所有worker进程的listenfd会在新连接到来时变得可读，为保证只有一个进程处理该连接，所有worker进程在注册listenfd读事件前抢accept_mutex，抢到<code>互斥锁</code>的那个worker进程注册listenfd读事件，在读事件里调用accept接受该连接。</p>
<p>当一个worker进程在accept这个连接之后，就开始读取请求，解析请求，处理请求，产生数据后，再返回给客户端，最后断开连接，这样就是一个完整的请求就是这样的了。</p>
<p>我们可以了解到一个请求，完全由worker进程来处理，且只在一个worker进程中处理。</p>
<h3 id="Nginx采用的IO多路复用模型"><a href="#Nginx采用的IO多路复用模型" class="headerlink" title="Nginx采用的IO多路复用模型"></a>Nginx采用的IO多路复用模型</h3><blockquote>
<p>IO多路复用是指内核一旦发现进程指定的一个或者多个IO条件准备读取，它就通知该进程，目前支持I/O多路复用的系统调用有 select ， poll ， epoll ，I/O多路复用就是通过一种机制，一个进程可以监视多个描述符(socket)，一旦某个描述符就绪(一般是读就绪或者写就绪)，能够通知程序进行相应的读 写操作。</p>
</blockquote>
<h5 id="select"><a href="#select" class="headerlink" title="select"></a>select</h5><h6 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h6><p>select 函数监视的文件描述符分3类，分别是writefds、readfds、和exceptfds。调用后select函数会阻塞，直到有描述符就绪（有数据 可读、可写、或者有except），或者超时（timeout指定等待时间，如果立即返回设为null即可），函数返回。当select函数返回后，可以通过遍历fdset，来找到就绪的描述符。</p>
<h6 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h6><ul>
<li>目前几乎在所有的平台上支持</li>
</ul>
<h6 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h6><blockquote>
<p>select本质上是通过设置或者检查存放fd标志位的数据结构来进行下一步处理。这样所带来的缺点是：</p>
</blockquote>
<ul>
<li>select最大的缺陷就是单个进程所打开的FD是有一定限制的，它由FD_SETSIZE设置，默认值是1024。（一般来说这个数目和系统内存关系很大，具体数目可以cat /proc/sys/fs/file-max查看。32位机默认是1024个。64位机默认是2048）</li>
<li>对socket进行扫描时是线性扫描，即采用轮询的方法，效率较低。（当套接字比较多的时候，每次select()都要通过遍历FD_SETSIZE个Socket来完成调度，不管哪个Socket是活跃的，都遍历一遍。这会浪费很多CPU时间。如果能给套接字注册某个回调函数，当他们活跃时，自动完成相关操作，那就避免了轮询，这正是epoll与kqueue做的）</li>
<li>需要维护一个用来存放大量fd的数据结构，这样会使得用户空间和内核空间在传递该结构时复制开销大。</li>
</ul>
<h5 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h5><h6 id="基本原理-1"><a href="#基本原理-1" class="headerlink" title="基本原理"></a>基本原理</h6><p>poll本质上和select没有区别，它将用户传入的数组拷贝到内核空间，然后查询每个fd对应的设备状态，如果设备就绪则在设备等待队列中加入一项并继续遍历，如果遍历完所有fd后没有发现就绪设备，则挂起当前进程，直到设备就绪或者主动超时，被唤醒后它又要再次遍历fd。这个过程经历了多次无谓的遍历。</p>
<h6 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h6><ul>
<li>它没有最大连接数的限制，原因是它是基于链表来存储的。</li>
</ul>
<h6 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h6><ul>
<li>大量的fd的数组被整体复制于用户态和内核地址空间之间，而不管这样的复制是不是有意义。</li>
<li>poll还有一个特点是“水平触发”，如果报告了fd后，没有被处理，那么下次poll时会再次报告该fd。</li>
</ul>
<p>注意：从上面看，select和poll都需要在返回后，通过遍历文件描述符来获取已经就绪的socket。事实上，同时连接的大量客户端在一时刻可能只有很少的处于就绪状态，因此随着监视的描述符数量的增长，其效率也会线性下降。</p>
<h5 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h5><p>epoll是在2.6内核中提出的，是之前的select和poll的增强版本。相对于select和poll来说，epoll更加灵活，没有描述符限制。epoll使用一个文件描述符管理多个描述符，将用户关系的文件描述符的事件存放到内核的一个事件表中，这样在用户空间和内核空间的copy只需一次。</p>
<h6 id="基本原理-2"><a href="#基本原理-2" class="headerlink" title="基本原理"></a>基本原理</h6><p>epoll支持水平触发和边缘触发，最大的特点在于边缘触发，它只告诉进程哪些fd刚刚变为就绪态，并且只会通知一次。还有一个特点是，epoll使用“事件”的就绪通知方式，通过epoll_ctl注册fd，一旦该fd就绪，内核就会采用类似callback的回调机制来激活该fd，epoll_wait便可以收到通知。</p>
<h6 id="epoll对文件描述符的操作有两种模式"><a href="#epoll对文件描述符的操作有两种模式" class="headerlink" title="epoll对文件描述符的操作有两种模式"></a>epoll对文件描述符的操作有两种模式</h6><p>LT（level trigger）和ET（edge trigger）。LT模式是默认模式，两者区别如下：</p>
<ul>
<li>LT模式：当epoll_wait检测到描述符事件发生并将此事件通知应用程序，应用程序可以不立即处理该事件。下次调用epoll_wait时，会再次响应应用程序并通知此事件。</li>
<li>ET模式：当epoll_wait检测到描述符事件发生并将此事件通知应用程序，应用程序必须立即处理该事件。如果不处理，下次调用epoll_wait时，不会再次响应应用程序并通知此事件。</li>
</ul>
<h6 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h6><ul>
<li>没有最大并发连接的限制，能打开的FD的上限远大于1024（1G的内存上能监听约10万个端口）。</li>
<li>效率提升，不是轮询的方式，不会随着FD数目的增加效率下降。<br>　　只有活跃可用的FD才会调用callback函数；即Epoll最大的优点就在于它只管你“活跃”的连接，而跟连接总数无关，因此在实际的网络环境中，Epoll的效率就会远远高于select和poll。</li>
<li>内存拷贝，利用mmap()文件映射内存加速与内核空间的消息传递；即epoll使用mmap减少复制开销。</li>
</ul>
<h5 id="kqueue"><a href="#kqueue" class="headerlink" title="kqueue"></a>kqueue</h5><p>kqueue与epoll非常相似，最初是2000年Jonathan Lemon在FreeBSD系统上开发的一个高性能的事件通知接口。注册一批socket描述符到 kqueue 以后，当其中的描述符状态发生变化时，kqueue 将一次性通知应用程序哪些描述符可读、可写或出错了。只是适应平台不多。</p>
<p>参考：</p>
<ul>
<li><a href="https://www.cnblogs.com/jeakeven/p/5435916.html" target="_blank" rel="noopener">网络通信 –&gt; IO多路复用之select、poll、epoll详解</a></li>
<li><a href="http://tengine.taobao.org/book/chapter_02.html#id1" target="_blank" rel="noopener">nginx平台初探</a></li>
</ul>
<blockquote>
<p> 这应该是Nginx系列最后一篇文章了，如果你有疑问，欢迎交流，水平有限，错误欢迎指正。</p>
</blockquote>
<hr>
<p>技术文章也发布在自己的公众号【爱好历史的程序员】，欢迎扫码关注，谢谢！</p>
<p><img alt="爱好历史的程序员" data-src="https://upload-images.jianshu.io/upload_images/8857285-075d6cd5c9d002b6.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" class="lazyload"></p>
</div></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/nginx/">nginx    </a></div><div class="post_share"><div class="social-share" data-image="/upload/article/nginx2.jpeg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="http://image.13sai.com/zan.jpg"><div class="post-qr-code__desc">微信</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/12/26/218/"><img class="prev_cover lazyload" data-src="https://upload-images.jianshu.io/upload_images/8857285-4172f1e723b1433c.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>五大网络IO模型</span></div></a></div><div class="next-post pull_right"><a href="/2019/12/20/215/"><img class="next_cover lazyload" data-src="/img/grpc.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>gRPC初体验</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/11/22/210/" title="Nginx内嵌变量"><img class="relatedPosts_cover lazyload"data-src="/upload/article/nginx1.jpeg"><div class="relatedPosts_title">Nginx内嵌变量</div></a></div><div class="relatedPosts_item"><a href="/2019/11/22/208/" title="Nginx代理缓存"><img class="relatedPosts_cover lazyload"data-src="/upload/article/nginx2.jpeg"><div class="relatedPosts_title">Nginx代理缓存</div></a></div><div class="relatedPosts_item"><a href="/2019/07/23/193/" title="nginx日志按日配置"><img class="relatedPosts_cover lazyload"data-src="http://img.13sai.com/1563789635000.png"><div class="relatedPosts_title">nginx日志按日配置</div></a></div><div class="relatedPosts_item"><a href="/2019/11/18/203/" title="Nginx负载均衡"><img class="relatedPosts_cover lazyload"data-src="http://img.13sai.com/1573999304000.png"><div class="relatedPosts_title">Nginx负载均衡</div></a></div><div class="relatedPosts_item"><a href="/2019/11/20/202/" title="Nginx添加lua-nginx模块"><img class="relatedPosts_cover lazyload"data-src="https://upload-images.jianshu.io/upload_images/8857285-4172f1e723b1433c.jpg"><div class="relatedPosts_title">Nginx添加lua-nginx模块</div></a></div><div class="relatedPosts_item"><a href="/2019/11/22/205/" title="Nginx配置常用参数，看这一篇就够了"><img class="relatedPosts_cover lazyload"data-src="/upload/article/nginx2.jpeg"><div class="relatedPosts_title">Nginx配置常用参数，看这一篇就够了</div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '56020318cc01a9d56fdd',
  clientSecret: '2fbbfefbb59c1247f4e212b7b83909302553911c',
  repo: '13sai.github.io',
  owner: '13sai',
  admin: '13sai',
  id: md5(decodeURI(location.pathname)),
  language: ''
})
gitalk.render('gitalk-container')</script></div></div></div><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2014 - 2020 By 13sai</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="icp"><a href="http://www.beian.miit.gov.cn" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"><span>皖ICP备14021992号</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>